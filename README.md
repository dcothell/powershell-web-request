# PowerShell Suspicious Web Request – Incident Response Case Study

## Overview

This case study documents the detection, investigation, and response to a suspicious PowerShell activity identified using Microsoft Sentinel. The activity involved PowerShell using `Invoke-WebRequest` to download remote scripts from the internet, followed by execution of those scripts on a Windows endpoint. This behavior aligns with common post-exploitation techniques observed in real-world attacks.

The incident was handled following the **NIST SP 800-61 Incident Response Lifecycle**.

---

## Environment

- **SIEM:** Microsoft Sentinel
- **Endpoint Protection:** Microsoft Defender for Endpoint (MDE)
- **Log Source:** DeviceProcessEvents
- **Operating System:** Windows (Cyber Range target endpoint)
- **Detection Type:** Scheduled Analytics Rule
- **Severity:** High
- **Incident Classification:** True Positive

---

## Threat Scenario

Attackers commonly abuse legitimate system tools such as PowerShell to blend in with normal activity. By leveraging `Invoke-WebRequest`, an attacker can download additional scripts or payloads from the internet and immediately execute them, bypassing traditional security controls.

This technique is often associated with:
- Post-exploitation activity
- Tool delivery
- Command-and-control communication
- Data exfiltration or ransomware staging

---

## Detection

### Analytics Rule Logic

A custom Microsoft Sentinel scheduled analytics rule was created to detect PowerShell downloading remote content.

```kql
DeviceProcessEvents
| where DeviceName == "windows-target-"
| where FileName == "powershell.exe"
| where ProcessCommandLine contains "Invoke-WebRequest"
````

### Rule Configuration

* **Run Frequency:** Every 4 hours
* **Lookup Period:** Last 24 hours
* **Alert Threshold:** Greater than 0 results
* **Event Grouping:** Group all alerts into a single incident per 24 hours
* **Incident Creation:** Enabled

### MITRE ATT&CK Mapping

* **T1059.001** – Command and Scripting Interpreter: PowerShell
* **T1105** – Ingress Tool Transfer
* **T1071** – Application Layer Protocol

---

## Incident Creation

The analytics rule successfully triggered, generating an incident titled:

**PowerShell – Suspicious Web Request**

The incident included mapped entities such as:

* Affected host
* PowerShell process
* Command-line activity

---

## Investigation

### Initial Findings

The Sentinel investigation graph confirmed:

* PowerShell execution on the affected endpoint
* Use of `Invoke-WebRequest` to retrieve remote scripts
* Activity originating from a single device

### Execution Confirmation

To determine whether the downloaded scripts were executed, the following query was used:

```kql
DeviceProcessEvents
| where DeviceName == "windows-target-"
| where FileName == "powershell.exe"
| where ProcessCommandLine contains "-File"
| order by TimeGenerated desc
```

### Results

Analysis confirmed that PowerShell executed multiple downloaded scripts using the `-File` parameter with execution policy bypass enabled.

Examples observed:

* `eicar.ps1`
* `portscan.ps1`
* `pwncrypt.ps1`

This confirmed successful payload execution rather than a download-only event.

---

## Evidence Collected

* PowerShell command-line logs
* Execution policy bypass usage
* Script execution paths (`C:\ProgramData\`)
* Multiple script executions
* Defender telemetry confirming process activity

---

## Root Cause Assessment

The activity is consistent with a user-initiated or automated process downloading and executing PowerShell scripts from an external source. In a real-world scenario, this behavior could result from installing untrusted software or clicking a malicious link. In this lab environment, the behavior was generated by the cyber range attack simulator.

---

## Containment

In a production environment, the affected endpoint would be isolated using Microsoft Defender for Endpoint to prevent further malicious activity and lateral movement.

**Note:**
Due to the shared cyber range environment, isolation was documented but not executed.

---

## Eradication and Recovery

An antimalware scan would be initiated on the affected endpoint to identify and remove malicious artifacts. No persistent threats were identified. In a real-world scenario, reimaging the system would be considered to ensure full remediation before returning the endpoint to service.

---

## Post-Incident Activities

* Incident findings documented within Microsoft Sentinel
* Detection rule validated and retained for continued monitoring
* PowerShell usage reviewed for non-essential users
* Additional security awareness training recommended

---

## Incident Closure

The incident was reviewed and closed as a **True Positive** after confirming malicious-like behavior and completing the investigation and response process.

---

## Key Takeaways

* PowerShell is frequently abused due to its legitimacy and flexibility
* Download activity alone is not sufficient—execution must be confirmed
* Command-line logging is critical for accurate incident analysis
* Sentinel analytics rules can effectively detect post-exploitation techniques
* Following a structured incident response lifecycle ensures consistent handling

---

## Skills Demonstrated

* Microsoft Sentinel analytics rule creation
* KQL querying and log analysis
* MITRE ATT&CK technique mapping
* Incident investigation and validation
* Endpoint containment strategy
* NIST SP 800-61 incident response methodology
